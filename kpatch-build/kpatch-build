#!/bin/bash

# kpatch build script for Fedora

# This script takes a patch based on the version of the kernel
# currently running and creates a kernel module that will
# replace modified functions in the kernel such that the
# patched code takes effect.

# This script contains Fedora specific nuances and will probably
# not work on other distributions; however, it does serve as a tutorial
# on the various steps involved and should be adaptable to other
# distributions.

# This script:
# - Installs the required yum/rpm tools
# - Downloads the kernel src rpm for the currently running kernel
# - Installs the build dependencies for the src rpm
# - Unpacks and prepares the src rpm for building
# - Builds the base kernel (vmlinux)
# - Builds the patched kernel and monitors changed objects
# - Builds the patched objects with gcc flags -f[function|data]-sections
# - Runs kpatch tools to create and link the patch kernel module

set -o errexit
set -o nounset

BASE="$PWD"
LOGFILE="$PWD/kpatch-build.log"
TOOLSDIR=/usr/local/libexec/kpatch
DATADIR=/usr/local/share/kpatch
ARCHVERSION="$(uname -r)"
DISTROVERSION="${ARCHVERSION%*.*}"
CPUS="$(grep -c ^processor /proc/cpuinfo)"
LOCALVERSION="$(uname -r)"
LOCALVERSION="-${LOCALVERSION##*-}"
KSRCDIR="$HOME/.kpatch/$ARCHVERSION"
KSRCDIR_DIR="$(dirname $KSRCDIR)"
KSRCDIR_CACHE="$KSRCDIR.tgz"
TEMPDIR=

cleanup() {
	rm -Rf "$KSRCDIR" "kernel-$DISTROVERSION.src.rpm" "$LOGFILE" "$TEMPDIR" > /dev/null 2>/dev/null
}

die() {
	echo "ERROR: kpatch build failed" >&2
	echo "check kpatch-build.log for more details" >&2
	exit 1
}

if [[ "$#" -ne 1 ]]; then
	echo "usage: $0 PATCH" >&2
	exit 2
fi

PATCHFILE="$(readlink -f $1)"
if [[ ! -f "$PATCHFILE" ]]; then
	echo "ERROR: patch file $PATCHFILE not found" >&2
	exit 3
fi

PATCHNAME="$(basename $PATCHFILE)"
if [[ "$PATCHNAME" =~ \.patch ]] || [[ "$PATCHNAME" =~ \.diff ]]; then
	PATCHNAME="${PATCHNAME%.*}"
fi

cleanup

TEMPDIR="$(mktemp -d)" || die

if [[ -f "$KSRCDIR_CACHE" ]]; then
	echo "Using cache at $KSRCDIR_CACHE"
	rm -rf "$KSRCDIR"
	tar xzf "$KSRCDIR_CACHE" -C "$KSRCDIR_DIR" || die
	cd "$KSRCDIR" || die
else
	echo "Verifying required development tools"
	yum install rpmdevtools yum-utils || die

	echo "Downloading kernel source for $ARCHVERSION"
	yumdownloader --source "kernel-$ARCHVERSION" || die

	echo "Verifying build dependencies for kernel package"
	yum-builddep "kernel-$DISTROVERSION.src.rpm" || die

	echo "Unpacking kernel source"
	rpmdev-setuptree >> "$LOGFILE" 2>&1 || die
	rpm -Uvh "kernel-$DISTROVERSION.src.rpm" >> "$LOGFILE" 2>&1 || die
	rpmbuild -bp "--target=$(uname -m)" "$HOME/rpmbuild/SPECS/kernel.spec" >> "$LOGFILE" 2>&1 || die
	rm -rf "$KSRCDIR"
	mkdir -p "$KSRCDIR_DIR"
	mv "$HOME"/rpmbuild/BUILD/kernel-*/linux-"$ARCHVERSION" "$KSRCDIR" >> "$LOGFILE" 2>&1 || die

	echo "Building original kernel"
	cd "$KSRCDIR"
	echo "$LOCALVERSION" > localversion
	make "-j$CPUS" vmlinux >> "$LOGFILE" 2>&1 || die

	echo "Creating cache"
	tar czf "$KSRCDIR_CACHE" -C "$KSRCDIR_DIR" "$ARCHVERSION"
fi

cp -R "$DATADIR/core" "$DATADIR/patch" "$TEMPDIR" || die
cp vmlinux "$TEMPDIR" || die

echo "Building patched kernel"
patch -p1 < "$PATCHFILE" >> "$LOGFILE" 2>&1
make "-j$CPUS" vmlinux > "$TEMPDIR/patched_build.log" 2>&1 || die

echo "Detecting changed objects"
grep CC "$TEMPDIR/patched_build.log" | grep -v init/version.o | awk '{print $2}' >> "$TEMPDIR/changed_objs"
if [[ $? -ne 0 ]]; then
	echo "No changed objects"
	exit 1
fi

echo "Rebuilding changed objects"
mkdir "$TEMPDIR/patched"
for i in "$(cat $TEMPDIR/changed_objs)"; do
	rm -f "$i"
	KCFLAGS="-ffunction-sections -fdata-sections" make "$i" >> "$LOGFILE" 2>&1 || die
	strip -d "$i"
	cp -f "$i" "$TEMPDIR/patched/"
	
done
patch -R -p1 < "$PATCHFILE" >> "$LOGFILE" 2>&1
mkdir "$TEMPDIR/orig"
for i in "$(cat $TEMPDIR/changed_objs)"; do
	rm -f "$i"
	KCFLAGS="-ffunction-sections -fdata-sections" make "$i" >> "$LOGFILE" 2>&1 || die
	strip -d "$i"
	cp -f "$i" "$TEMPDIR/orig/"
done

echo "Extracting new and modified ELF sections"
cd "$TEMPDIR"
mkdir output
for i in orig/*; do
	FILE="$(basename $i)"
	"$TOOLSDIR"/create-diff-object "orig/$FILE" "patched/$FILE" "output/$FILE" >> "$LOGFILE" 2>&1 || die
done

echo "Building core module: kpatch.ko"
cd core
KPATCH_BUILD="$KSRCDIR" make >> "$LOGFILE" 2>&1 || die
cd ..

echo "Building patch module: kpatch-$PATCHNAME.ko"
cd patch
ld -r -o output.o ../output/* >> "$LOGFILE" 2>&1 || die
"$TOOLSDIR"/add-patches-section output.o ../vmlinux >> "$LOGFILE" 2>&1 || die
KPATCH_BASEDIR="$TEMPDIR/core" KPATCH_BUILD="$KSRCDIR" KPATCH_NAME="$PATCHNAME" make >> "$LOGFILE" 2>&1 || die
strip -d "kpatch-$PATCHNAME.ko" >> "$LOGFILE" 2>&1 || die
"$TOOLSDIR"/link-vmlinux-syms "kpatch-$PATCHNAME.ko" ../vmlinux >> "$LOGFILE" 2>&1 || die

echo "SUCCESS"
cp -f "$TEMPDIR/patch/kpatch-$PATCHNAME.ko" "$TEMPDIR/core/kpatch.ko" "$BASE"
cleanup
